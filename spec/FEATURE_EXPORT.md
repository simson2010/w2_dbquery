# 功能 ： FEATURE EXPORT

## 描述
用户可以将查询结果以JSON或CSV的格式导出，下载到本地。

---

## 用户故事

作为一个数据分析师，我希望能够将SQL查询结果导出为JSON或CSV格式，以便在Excel、Python或其他工具中进一步分析数据。

### 验收标准
- 用户执行SQL查询后，可以看到导出按钮
- 用户可以选择导出格式（JSON或CSV）
- 点击导出后，文件自动下载到本地
- 导出的文件名包含时间戳，便于区分
- 空结果集时，导出按钮应禁用或隐藏

---

## 功能需求

### FR-1: 导出格式支持
- **FR-1.1**: 支持导出为 JSON 格式
  - 格式为对象数组，每个对象代表一行数据
  - 键名为列名，值为对应的单元格数据
- **FR-1.2**: 支持导出为 CSV 格式
  - 第一行为表头（列名）
  - 使用逗号分隔
  - 字符串值用双引号包裹
  - 支持 UTF-8 编码（含 BOM，确保 Excel 正确识别中文）

### FR-2: 导出触发
- **FR-2.1**: 在查询结果区域显示导出按钮
- **FR-2.2**: 提供格式选择下拉菜单或按钮组
- **FR-2.3**: 仅在有查询结果时启用导出功能

### FR-3: 文件下载
- **FR-3.1**: 文件名格式：`query_export_YYYYMMDD_HHmmss.{json|csv}`
- **FR-3.2**: 使用浏览器原生下载功能，无需后端参与
- **FR-3.3**: 下载完成后显示成功提示

---

## 非功能需求

### NFR-1: 性能
- 导出操作应在前端完成，避免额外的网络请求
- 支持导出至少 10,000 行数据而不卡顿

### NFR-2: 兼容性
- CSV 文件应能被 Microsoft Excel、Google Sheets 正确打开
- JSON 文件应符合标准 JSON 格式

### NFR-3: 用户体验
- 导出按钮应有明确的图标和文字提示
- 大数据量导出时应显示加载状态

---

## UI/UX 设计

### 界面布局
在 `ResultTable` 组件的记录数统计旁边添加导出功能：

```
┌─────────────────────────────────────────────────────────────┐
│ 查询结果                                                      │
├─────────────────────────────────────────────────────────────┤
│ 共 100 条记录                    [导出 JSON] [导出 CSV]       │
├─────────────────────────────────────────────────────────────┤
│ | col1 | col2 | col3 |                                      │
│ |------|------|------|                                      │
│ | ...  | ...  | ...  |                                      │
└─────────────────────────────────────────────────────────────┘
```

### 交互流程
1. 用户执行 SQL 查询，结果显示在表格中
2. 用户点击「导出 JSON」或「导出 CSV」按钮
3. 浏览器自动下载对应格式的文件
4. 显示 Toast 提示「导出成功」

### 按钮状态
- **启用状态**: 有查询结果时，按钮可点击
- **禁用状态**: 无查询结果或正在查询时，按钮置灰且不可点击

---

## 技术方案

### 前端实现（纯前端方案）

#### 1. 创建导出工具函数
文件：`frontend/src/utils/export.ts`

```typescript
// 将查询结果转换为 JSON 并下载
export function exportToJson(columns: string[], rows: unknown[][]): void

// 将查询结果转换为 CSV 并下载
export function exportToCsv(columns: string[], rows: unknown[][]): void

// 生成带时间戳的文件名
function generateFileName(extension: string): string
```

#### 2. 修改 ResultTable 组件
- 添加导出按钮
- 调用导出工具函数

### 数据转换逻辑

#### JSON 格式示例
输入：
- columns: `["id", "name", "age"]`
- rows: `[[1, "Alice", 25], [2, "Bob", 30]]`

输出：
```json
[
  {"id": 1, "name": "Alice", "age": 25},
  {"id": 2, "name": "Bob", "age": 30}
]
```

#### CSV 格式示例
输入：
- columns: `["id", "name", "age"]`
- rows: `[[1, "Alice", 25], [2, "Bob", 30]]`

输出：
```csv
"id","name","age"
1,"Alice",25
2,"Bob",30
```

---

## 开发步骤

### Step 1: 创建导出工具函数
**文件**: `frontend/src/utils/export.ts`

**任务**:
1. 创建 `utils` 目录（如不存在）
2. 实现 `exportToJson` 函数
   - 将 columns 和 rows 转换为对象数组
   - 使用 `JSON.stringify` 格式化
   - 创建 Blob 并触发下载
3. 实现 `exportToCsv` 函数
   - 生成 CSV 格式字符串
   - 处理特殊字符（逗号、引号、换行）
   - 添加 UTF-8 BOM
   - 创建 Blob 并触发下载
4. 实现 `generateFileName` 辅助函数

**验证**: 编写单元测试验证转换逻辑

### Step 2: 修改 ResultTable 组件
**文件**: `frontend/src/components/ResultTable.tsx`

**任务**:
1. 导入导出工具函数
2. 在记录数统计行添加导出按钮
3. 实现按钮点击事件处理
4. 根据数据状态控制按钮启用/禁用

**验证**: 手动测试导出功能

### Step 3: 添加导出成功提示
**文件**: `frontend/src/pages/Home.tsx`

**任务**:
1. 将导出函数通过 props 或回调传递给 ResultTable
2. 导出成功后调用 `addToast` 显示提示

**验证**: 确认导出后有成功提示

### Step 4: 样式优化
**任务**:
1. 确保导出按钮与现有 UI 风格一致
2. 添加适当的图标（可选）
3. 响应式布局适配

**验证**: 在不同屏幕尺寸下测试 UI

### Step 5: 测试与验收
**任务**:
1. 测试 JSON 导出功能
   - 验证文件格式正确
   - 验证中文字符正常显示
2. 测试 CSV 导出功能
   - 用 Excel 打开验证格式
   - 验证特殊字符处理
3. 测试边界情况
   - 空结果集
   - 大数据量（1000+ 行）
   - 包含 NULL 值的数据
   - 包含特殊字符的数据

---

## 测试用例

| 用例ID | 场景 | 预期结果 |
|--------|------|----------|
| TC-01 | 导出包含 100 行数据的 JSON | 文件下载成功，格式正确 |
| TC-02 | 导出包含 100 行数据的 CSV | 文件下载成功，Excel 可正常打开 |
| TC-03 | 导出包含中文的数据 | 中文字符正常显示 |
| TC-04 | 导出包含 NULL 值的数据 | NULL 值正确处理（JSON: null, CSV: 空） |
| TC-05 | 导出包含逗号的字符串 | CSV 中正确转义 |
| TC-06 | 导出包含引号的字符串 | CSV 中正确转义 |
| TC-07 | 无查询结果时点击导出 | 按钮禁用，无法点击 |
| TC-08 | 导出 10000 行数据 | 导出成功，无明显卡顿 |

---

## 风险与注意事项

1. **大数据量处理**: 如果数据量过大（超过 100,000 行），前端处理可能导致浏览器卡顿，后续可考虑后端流式导出
2. **特殊字符处理**: CSV 格式需要正确处理逗号、引号、换行符等特殊字符
3. **浏览器兼容性**: 确保 Blob 和 download 属性在目标浏览器中正常工作
